#!/usr/bin/env node
///////////////////////////////////////////////////////////////////////////////

var ArgumentParser = require('argparse').ArgumentParser,
    ByteBuffer = require('bytebuffer'),
    now = require('performance-now'),
    WebSocket = require('ws');

///////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////

var parser = new ArgumentParser({
  addHelp: true, description: 'RPC Client', version: '0.0.1'
});

parser.addArgument(['port'], {
    nargs: '?', help: 'Server Port', defaultValue: '8088'
});
parser.addArgument(['host'], {
    nargs: '?', help: 'Server Host', defaultValue: 'localhost'
});

///////////////////////////////////////////////////////////////////////////////

var args = parser.parseArgs();

///////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////

var ws = new WebSocket('ws://' + args.host + ':' + args.port);

///////////////////////////////////////////////////////////////////////////////

ws.onmessage = function (ev) {
    var bb = ByteBuffer.fromBinary(ev.data);
    console.log(now() - bb.readFloat64());
};

///////////////////////////////////////////////////////////////////////////////

ws.onopen = function () {
    var bb = new ByteBuffer();
    var id = setInterval(function () {
        bb.flip().writeFloat64(now());
        ws.send(bb.flip().toBuffer(), {
            binary: true
        });
    }, 0);

    setTimeout(function () {
        clearInterval(id);
        ws.close();
    }, 10000);
};

///////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////
