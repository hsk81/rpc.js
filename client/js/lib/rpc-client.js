#!/usr/bin/env node
///////////////////////////////////////////////////////////////////////////////

var ArgumentParser = require('argparse').ArgumentParser,
    moment = require('moment'),
    sprintf = require('sprintf-js').sprintf,
    WebSocket = require('ws');

///////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////

var parser = new ArgumentParser({
  addHelp: true, description: 'RPC Client', version: '0.0.1'
});

parser.addArgument(['port'], {
    nargs: '?', help: 'Server Port', defaultValue: '8088'
});
parser.addArgument(['host'], {
    nargs: '?', help: 'Server Host', defaultValue: 'localhost'
});

///////////////////////////////////////////////////////////////////////////////

var args = parser.parseArgs();

///////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////

var ws = new WebSocket('ws://{host}:{port}'
    .replace('{host}', args.host)
    .replace('{port}', args.port)
);

///////////////////////////////////////////////////////////////////////////////

ws.onmessage = function (ev) {

    var next = moment(),
        diff = next.diff(GLOBAL.last || moment());

    GLOBAL.last = next;

    var p1 = sprintf('%03f', diff),
        p2 = '[' + next.toISOString() + ']',
        p3 = ev.data;

    console.log(p1, p2, p3);
};

///////////////////////////////////////////////////////////////////////////////

ws.onopen = function () {
    var id = setInterval(function () { ws.send('.')}, 0);
    setTimeout(function () { clearInterval(id); }, 10000);
};

///////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////
